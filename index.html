<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <div class="mixpanel-platform-section">
      <div class="instructions">
        <h1 style="font-size: 18px; color: rgb(95,105,131)">CoTap Dashboard</h1>
        <p style="font-size: 13px; color: rgb(95,105,131)">Please confirm a company name (that is included in the email address of its users, e.g., "Mixpanel" or "mixpanel.com") before selecting events.</p>
      </div>
      <div id="dateSelect" style="float: right;"></div>
      <div id="companySelect" style="margin-bottom: 15px; display: none"></div>
      <form id="company" style="margin-bottom: 15px; height: 31px">
        <input type="text" autofocus placeholder="Email address contains" name="company-name-field" value="" style="color: rgb(95,105,131); height: 30px; padding: 0 4px; font-size: 12px; border: 1px solid rgb(201,209,219)">
        <input type="submit" name="submit" value="Confirm" style="color: rgb(95,105,131); font-size: 12px; height: 31px; padding: 0 10px; margin-left: 10px; border: 1px solid rgb(201,209,219); background-color: rgb(242,244,246)">
      </form>
      <div class="confirmation">
        <p class="confirm-text" style="color: rgb(95,105,131); font-size: 15px"></p>
      </div>
      <div class="event-selects">
        <div id="event1" style="margin-bottom: 15px"></div>
        <div id="event2" style="margin-bottom: 15px; display: none"></div>
        <div id="event3" style="margin-bottom: 15px; display: none"></div>
        <div id="event4" style="display: none"></div>
      </div>
      <div style="clear: both;"></div>
      <div id="graph"></div>
    </div>
    <div id="table"></div>
    <div id="table-holder">
      <div id="table1"></div>
      <div id="table2"></div>
      <div id="table3"></div>
      <div id="table4"></div>
    </div>
    <script>
    
      // populate each dropdown with the project's events, properties, and dates
      var event1 = $('#event1').MPEventSelect(),
          event2 = $('#event2').MPEventSelect(),
          event3 = $('#event3').MPEventSelect(),
          event4 = $('#event4').MPEventSelect(),
          dateSelect  = $('#dateSelect').MPDatepicker(),
          eventGraph  = $('#graph').MPChart({chartType: 'line', highchartsOptions: {
              tooltip: {
                  backgroundColor: '#fffce7'  // Make tooltip background yellow
              }
          }}),
          options = {'items': [{label: '-- Select Company --', value: ''},]},
          companyName = '',
          numPeople = 0,
          companySelect = $('#companySelect').MPSelect(options);
      var table1  = $('#table1').MPTable({
            showPercentages: true,
            firstColHeader: 'Event'
          }),
          table2  = $('#table2').MPTable({
            showPercentages: true,
            firstColHeader: 'Event'
          }),
          table3  = $('#table3').MPTable({
            showPercentages: true,
            firstColHeader: 'Event'
          }),
          table4  = $('#table4').MPTable({
            showPercentages: true,
            firstColHeader: 'Event'
          });

      $('#company').submit(function(e) {
        e.preventDefault();
        companyName = $('#company input:first').val();
        MP.api.people({where: "(\"" + companyName + "\" in properties[\"$email\"])"}).done(function(results) {
          numPeople = Object.keys(results.values().results).length;
          console.log(numPeople);
          $('.confirm-text').html("Company: <strong>" + companyName + "</strong>; People profiles who match: <strong>" + numPeople + "</strong>").css("color", "rgb(95,105,131)")
          runQuery();
        });
      });
      
      // MP.api.propertyValues("Signed up", "$email").done(function(results) {
      //   $.each(results.values(), function(i, propertyValue) {
      //     options['items'].push({label: propertyValue, value: propertyValue});
      //   });
      //   $('#companySelect').MPSelect(options);
      // });

      // run when any dropdown is altered
      var runQuery = function(tableName) {
        
        if (!companyName) {
          $('.confirm-text').html("Error: Please enter a company name above. Be sure to change the event below and then go back to your selection.").css("color", "red");
          $('#event1').val('-- Select an event --'); ////// this needs to be fixed
        }
        else {
          var data = {},
              eventNames = [event1, event2, event3, event4];
              //companyName = $('#companySelect').val();
              
          $.each(eventNames, function(i, event) {
            var newData = {};
            // obtain event name and date range values from dropdowns
            var eventName = event.MPEventSelect('value'),
                dateRange = dateSelect.MPDatepicker('value'),
                fromDate,
                toDate;
            // assign from_date and to_date from date picker
            $.each(dateRange, function(param, value) {
              if (param == "from") {
                fromDate = value;
              }
              else if (param == "to") {
                toDate = value;
              }
            });
            
            if (eventName) {
              newData[eventName] = {};
              data[eventName] = {};
              // set parameters to be sent with segment query
              params = {
                from: fromDate,
                to: toDate,
                // set parameter that looks for the specific company name for which we will filter all events
                "where": "(\"" + companyName + "\" in properties[\"$email\"])",
              }
              // perform segment query and append results to data
              MP.api.segment(eventName, params).done(function(results) {
                $.each(results.values(), function(i, value) {
                  $.each(value, function(date, numEvents) {
                    newData[eventName][date] = numEvents;
                    data[eventName][date] = numEvents;
                  });
                });
                // update Graph and Table with data for each event
                eventGraph.MPChart('addSeries', newData);
                //$('#table').MPTable({data: newData, showPercentages: true, firstColHeader: 'Event'}).css("visibility", "visible"); 
                //$(tableName).MPTable({data: newData, showPercentages: true, firstColHeader: 'Event'}).css("visibility", "visible");
                $(tableName).MPTable('setData', newData);
              });
            }
          });
        }
      };
      
      event1.on('change', function(e, eventName) {
        runQuery('#table1');
        event2.show();
      });
      event2.on('change', function(e, eventName) {
        runQuery('#table2');
        event3.show();
        //table1.hide();
      });
      event3.on('change', function(e, eventName) {
        runQuery('#table3');
        event4.show().css("margin-bottom", "15px");
        //table2.hide();
      });
      event4.on('change', function(e, eventName) {
        runQuery('#table4');
        //table3.hide();
      });
      
      companySelect.on('change', runQuery);
      dateSelect.on('change', runQuery);
      
    </script>
  </body>
</html>
